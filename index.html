<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src='js/vue.js'></script>
  <title>snow flake</title>
  <link rel="stylesheet" href="https://unpkg.com/purecss@0.6.2/build/pure-min.css" integrity="sha384-" crossorigin="anonymous">
  <link rel="stylesheet" href="css/layouts/side-menu.css" >
  <style>
    /*阻止在手机上输入时自动放大*/
    input[type='text'],
    input[type='number'],
    textarea {
      font-size: 16px;
    }
    textarea {
      overflow-y: hidden;
      resize: none;
    }

    .custom-textarea {
      position: relative;
    }
    .custom-textarea span {
      position: absolute;
      right: 10px;
      color: #ddd;
    }
    .custom-textarea textarea {
      width: 100%;
      padding-top: 15px;
    }

    #menu a.selected {
      color: #fff;
      background: #333;
    }


  </style>
</head>
<body>

  <div id="app">
    <div id="layout" :class="{active: isactive}">
      <side-nav :steps="steps" :selected="selected" :isactive="isactive" @selected="setSelected" @togglemenu="togglemenu"></side-nav>
      <div id="main">
        <div class="header">
          <h1>Snow flake</h1>
          <h2>A method help you write better</h2>
        </div>
        <div class="content">
          <div class="sec" v-for="(step, index) of steps" v-show="index == selected" :key="index">
            <component
              :is="step.name"
              :desc="step.desc"
              :content="step.content"
              :charactors="charactors"
              :scenes="scenes"
              :index="index"
              :former-content="step.former > -1 ? steps[step.former]['content'] : null"
            >
            </component>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="x-template" id="type-1">
    <form class="pure-form">
      <hint :desc="desc" :index="index" :former-content="formerContent"></hint>
      <custom-textarea
        :index="index"
        :content="content"
      >
      </custom-textarea>
    </form>
  </script>

  <script type="x-template" id="type-2">
    <form class="pure-form pure-form-stacked">
      <hint :desc="desc" :index="index"></hint>
      <main-charactors
        :charactors="charactors"
      ></main-charactors>
    </form>
  </script>

  <script type="x-template" id="type-3">
    <form class="pure-form pure-form-stacked">
      <hint :desc="desc" :index="index"></hint>
      <charactors
        :charactors="charactors"
      ></charactors>
    </form>
  </script>

  <script type="x-template" id="type-4">
    <form class="pure-form pure-form-stacked">
      <hint :desc="desc" :index="index" :former-content="formerContent"></hint>
      <scenes
        :scenes="scenes"
      ></scenes>
    </form>
  </script>

  <script type="x-template" id="type-5">
    <form class="pure-form pure-form-stacked">
      <hint :desc="desc" :index="index"></hint>
      <scenes-detail
        :scenes="scenes"
      ></scenes-detail>
    </form>
  </script>


  <script type="x-template" id="hint">
    <div>
      <h2 class="content-subhead">{{index + 1}}.{{ desc.main }}</h2>
      <blockquote class="content-quote">{{ formerContent }}</blockquote>
      <p>{{ desc.supplement }}</p>
    </div>
  </script>

  <script type="x-template" id="custom-textarea">
    <div class="custom-textarea">
      <span>{{wordsCount}}</span>
      <textarea @input="handleInput" v-model="innerContent"></textarea>
    </div>
  </script>

  <script type="x-template" id="main-charactors">
    <fieldset>
      <div class="pure-controls">
        <button @click="add" class="pure-button pure-button-primary" type="button">新增</button>
      </div>
      <div v-for="(charactor, index) in charactors" :key="index" >
          <label>角色类型: </label>
          <select v-model="charactor.type">
            <option v-for="option in options" :value="option.value">
              {{ option.text }}
            </option>
          </select>
          <label>姓名: </label>
          <input type="text" v-model="charactor.name">
          <label>一句话故事情节: </label>
          <input type="text" v-model="charactor.short_story">
          <label>抽象动机: </label>
          <input type="text" v-model="charactor.abstract_emo">
          <label>具体动机: </label>
          <input type="text" v-model="charactor.specific_emo">
          <label>阻碍: </label>
          <input type="text" v-model="charactor.obstacle">
          <label>最终感悟: </label>
          <input type="text" v-model="charactor.final_thought">
          <label>一段话故事情节: </label>
          <input type="text" v-model="charactor.medium_story">
        <div class="pure-controls">
          <button @click="deleteCharactor(index)" class="pure-button" type="button">删除</button>
        </div>
      </div>
    </fieldset>
  </script>

  <script type="x-template" id="charactors">

    <fieldset>
      <div class="pure-controls">
        <button @click="add" class="pure-button pure-button-primary" type="button">新增</button>
      </div>
      <div v-for="(charactor, index) in charactors" :key="index" >
        <label>姓名: </label>
        <input type="text" v-model="charactor.name">
        <label>角色类型: </label>
        <select v-model="charactor.type">
          <option v-for="option in options" :value="option.value">
            {{ option.text }}
          </option>
        </select>
        <label>一句话故事情节: </label>
        <input type="text" v-model="charactor.short_story">
        <label>抽象动机: </label>
        <input type="text" v-model="charactor.abstract_emo">
        <label>具体动机: </label>
        <input type="text" v-model="charactor.specific_emo">
        <label>阻碍: </label>
        <input type="text" v-model="charactor.obstacle">
        <label>最终感悟: </label>
        <input type="text" v-model="charactor.final_thought">
        <label>一段话故事情节: </label>
        <input type="text" v-model="charactor.medium_story">
        <label>总体故事情节:</label>
        <input type="text" v-model="charactor.long_story">
        <div class="pure-controls">
          <button @click="deleteCharactor(index)" class="pure-button" type="button">删除</button>
        </div>
      </div>
    </fieldset>
  </script>

  <script type="x-template" id="scenes">
    <div>
      <button @click="add" class="pure-button pure-button-primary" type="button">新增</button>
      <div v-for="(scene, index) in scenes" :key="index">
        <span>出场人物： <input type="text" v-model="innerCharactors[index]" @input="addCharactors(index, $event)" placeholder="用空格分隔" /></span>
        <span>故事情节： <input type="text" v-model="scene.short_story" /></span>
        <span>预计篇幅： <input type="number" v-model="scene.length" placeholder="写多少字？" /></span>
        <button @click="deleteScene(index)" class="pure-button" type="button">删除</button>
      </div>
    </div>
  </script>

  <script type="x-template" id="scenes-detail">
    <div>
      <div v-for="(scene, index) in scenes" :key="index">
        <span>故事情节： <input type="text" v-model="scene.short_story" /></span>
        <span>完整故事： <input type="text" v-model="scene.long_story" /></span>
      </div>
    </div>
  </script>

  <script type="x-template" id="side-nav">
    <div>
      <!-- Menu toggle -->
      <a
        href="#menu"
        id="menuLink"
        class="menu-link "
        :class="{'active': isactive}"
        @click="$emit('togglemenu')"
      >
        <!-- Hamburger icon -->
        <span></span>
      </a>
      <div id="menu" :class="{'active': isactive}">
        <div class="pure-menu">
          <a class="pure-menu-heading" href="#">步骤</a>
          <ul class="pure-menu-list">
            <li class="pure-menu-item" v-for="(step, index) in steps">
              <a @click="$emit('selected', index)" :class="{ selected : selected == index }" href="#" class="pure-menu-link">第 {{ index + 1 }} 步</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </script>

  <script>
    Vue.component('side-nav', {
      props: ['steps', 'selected', 'isactive'],
      template: '#side-nav'
    });

    Vue.component('hint', {
      props: ['desc', 'formerContent', 'index'],
      template: '#hint'
    });

    Vue.component('main-charactors', {
      props: ['charactors'],
      template: '#main-charactors',
      data: function(){
        return {
          options: [
            {text: '主要角色', value: 'major'},
            {text: '次要角色', value: 'minor'}
          ]
        }
      },
      methods: {
        add: function(){
          this.$root.$emit('add-charactor');
        },
        deleteCharactor: function(index){
          this.$root.$emit('delete-charactor', index);
        }
      }

    });

    Vue.component('charactors', {
      props: ['charactors'],
      template: '#charactors',
      data: function(){
        return {
          options: [
            {text: '主要角色', value: 'major'},
            {text: '次要角色', value: 'minor'}
          ]
        }
      },
      methods: {
        add: function(){
          this.$root.$emit('add-charactor');
        },
        deleteCharactor: function(index){
          this.$root.$emit('delete-charactor', index);
        }
      }

    });

    Vue.component('scenes', {
      props: ['scenes'],
      template: '#scenes',
      data: function(){
        return {
          innerCharactors: this.scenes.map(function(scene){
            return scene.charactors.join(' ')
          })
        }
      },
      methods: {
        add: function(){
          this.$root.$emit('add-scene');
        },
        addCharactors: function(index, e){
          var charactors = e.target.value.split(' ');
          this.$root.$emit('add-scene-charactors', index, charactors);
        },
        deleteScene: function(index){
          this.$root.$emit('delete-scene', index);
        }
      }

    });

    Vue.component('custom-textarea', {
      props: ['index', 'content'],
      template: '#custom-textarea',
      data: function(){
        return {
          innerContent: this.content,
          wordsCount: this.content ? this.content.trim().length : 0
        }
      },
      methods: {
        handleInput: function(event){
          this.resetHeight(event);
          this.wordsCount = event.target.value.trim().length;
          this.$root.$emit('update-content', this.index, (this.innerContent).trim());
        },
        resetHeight: function(event){
          event.target.style.height = 'auto';
          event.target.style.height = (event.target.scrollHeight) + 'px';
        }
      }
    });

    Vue.component('scenes-detail', {
      props: ['scenes'],
      template: '#scenes-detail'
    });

    new Vue({
      el: '#app',
      components: {
        one: {
          template: '#type-1',
          props: ['index', 'content', 'formerContent'],
          data: function(){
            return {
              desc: {
                main: '用一句话总结小说的内容',
                supplement: '长度不超过 30 个字'
              }
            }
          }
        },
        two: {
          template: '#type-1',
          props: ['index', 'content', 'formerContent'],
          data: function(){
            return {
              desc: {
                main: '把第 1 步写的话扩写成一段话',
                supplement: '这段话包含 5 个句子：故事开头（1句），主角经受的主要磨难（3句），以及结尾（1句）'
              }
            }
          }
        },
        three: {
          template: '#type-2',
          props: ['index', 'charactors'],
          data: function(){
            return {
              desc: {
                main: '塑造主要人物',
                supplement: '每个主要角色都应该有以下内容：姓名，一句话总结的角色故事情节，角色的动机（偏向于抽象的），角色的目标（偏向于具体的），阻碍角色达到目标的事物，角色最终的感悟，一段话总结的角色故事情节'
              }
            }
          }
        },
        four: {
          template: '#type-1',
          props: ['index', 'content', 'formerContent'],
          data: function(){
            return {
              desc: {
                main: '扩写那段故事梗概',
                supplement: '将内容扩充到 800 字'
              }
            }
          }
        },
        five: {
          template: '#type-3',
          props: ['index', 'charactors'],
          data: function(){
            return {
              desc: {
                main: '描述故事的每个角色',
                supplement: '为每个主要角色写上 800 字的描述，为其他重要角色也写 400 字描述（要从每个角色的角度去描述整个故事）'
              }
            }
          }
        },
        six: {
          template: '#type-1',
          props: ['index', 'content', 'formerContent'],
          data: function(){
            return {
              desc: {
                main: '继续扩写故事梗概',
                supplement: '将一页纸的故事概述，扩写成 3200 字'
              }
            }
          }
        },
        seven: {
          template: '#type-3',
          props: ['index', 'charactors'],
          data: function(){
            return {
              desc: {
                main: '完善每个角色的所有资料',
                supplement: '在故事的末尾，角色有了什么样的转变、收获'
              }
            }
          }
        },
        eight: {
          template: '#type-4',
          props: ['index', 'scenes', 'formerContent'],
          data: function(){
            return {
              desc: {
                main: '罗列出所有故事场景的概述',
                supplement: '把 3200 字的故事梗概拆分成一幕幕的故事场景。每个场景的信息包含：出场人物、故事、篇幅（大约写多少字）'
              }
            }
          }
        },
        nine: {
          template: '#type-5',
          props: ['index', 'scenes'],
          data: function(){
            return {
              desc: {
                main: '扩写每一条场景',
                supplement: '把每一条场景扩写成一段话。要在每一段中出现冲突，如果做不到，就去掉那条场景'
              }
            }
          }
        }
      },
      data: {
        charactors: [{
          name: '',
          type: 'major',
          short_story: '',
          abstract_emo: '',
          specific_emo: '',
          obstacle: '',
          final_thought: '',
          medium_story: ''
        }],
        scenes: [{
          charactors: [],
          short_story: '',
          long_story: '',
          length: null
        }],
        steps: [{
          name: 'one',
          former: -1,
          content: ''
        },{
          name: 'two',
          former: 0,
          content: ''
        },{
          name: 'three',
          former: -1
        },{
          name: 'four',
          former: 1,
          content: ''
        },{
          name: 'five',
          former: -1
        },{
          name: 'six',
          former: 3,
          content: ''
        },{
          name: 'seven',
          former: -1
        },{
          name: 'eight',
          former: 5
        },{
          name: 'nine',
          former: -1
        }
//
// ,{
//          num: 10,
//          name: '10',
//          desc: {
//            main: '写初稿',
//            supplement: ''
//          }
//        },{
//          num: 11,
//          name: '11',
//          desc: {
//            main: '完善作品',
//            supplement: ''
//          }
//        }
],
        selected: 0,
        isactive: false
      },

      mounted: function(){
        this.$on('update-content', this.updateContent);
        this.$on('add-charactor', this.addCharactor);
        this.$on('delete-charactor', this.deleteCharactor);

        this.$on('delete-scene', this.deleteScene);
        this.$on('add-scene', this.addScene);
        this.$on('add-scene-charactors', this.addSceneCharactors);
      },
      methods: {
        setSelected: function(step){
          this.selected = step;
        },

        togglemenu: function(){
          this.isactive = !this.isactive;
        },

        updateContent: function(index, content){
          this.steps[index]['content'] = content;
        },

        addCharactor: function(){
          var charactor = {
            name: '',
            type: 'major',
            short_story: '',
            abstract_emo: '',
            specific_emo: '',
            obstacle: '',
            final_thought: '',
            medium_story: '',
            long_story: ''
          };
          this.charactors.push(charactor);
        },

        deleteCharactor: function(index){
          this.charactors.splice(index, 1);
        },

        addScene: function(){
          var scene = {
            charactors: [],
            short_story: '',
            long_story: '',
            length: null
          };
          this.scenes.push(scene);
        },

        deleteScene: function(index){
          this.scenes.splice(index, 1);
        },

        addSceneCharactors: function(index, charactors){
          this.scenes[index]['charactors'] = charactors;
        }

      }
    });



  </script>
</body>
</html>